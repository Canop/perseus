
<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">

<head>
    <!-- Book generated using mdBook -->
    <meta charset="UTF-8">
    <title>Request State - Perseus Book</title>
        

    <!-- Custom HTML head -->
    

    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
            <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
    <link rel="stylesheet" href="../css/general.css">
    <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
    
    <!-- Fonts -->
    <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
    
    <!-- Highlight.js Stylesheets -->
    <link rel="stylesheet" href="../highlight.css">
    <link rel="stylesheet" href="../tomorrow-night.css">
    <link rel="stylesheet" href="../ayu-highlight.css">

    <!-- Custom theme stylesheets -->
    
    </head>

<body>
    <!-- Provide site root to javascript -->
    <script type="text/javascript">
        var path_to_root = "../";
        var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
    </script>

    <!-- Work around some values being stored in localStorage wrapped in quotes -->
    <script type="text/javascript">
        try {
            var theme = localStorage.getItem('mdbook-theme');
            var sidebar = localStorage.getItem('mdbook-sidebar');
            if (theme.startsWith('"') && theme.endsWith('"')) {
                localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
            }
            if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
            }
        } catch (e) { }
    </script>

    <!-- Set the theme before any content is loaded, prevents flash -->
    <script type="text/javascript">
        var theme;
        try { theme = localStorage.getItem('mdbook-theme'); } catch (e) { }
        if (theme === null || theme === undefined) { theme = default_theme; }
        var html = document.querySelector('html');
        html.classList.remove('no-js')
        html.classList.remove('light')
        html.classList.add(theme);
        html.classList.add('js');
    </script>

    <!-- Hide / unhide sidebar before it is displayed -->
    <script type="text/javascript">
        var html = document.querySelector('html');
        var sidebar = 'hidden';
        if (document.body.clientWidth >= 1080) {
            try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch (e) { }
            sidebar = sidebar || 'visible';
        }
        html.classList.remove('sidebar-visible');
        html.classList.add("sidebar-" + sidebar);
    </script>

    <nav id="sidebar" class="sidebar" aria-label="Table of contents">
        <div class="sidebar-scrollbox">
            <ol class="chapter"><li class="chapter-item expanded "><a href="../intro.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../setup.html"><strong aria-hidden="true">2.</strong> Setup</a></li><li class="chapter-item expanded "><a href="../arch.html"><strong aria-hidden="true">3.</strong> Architecture</a></li><li class="chapter-item expanded "><a href="../tutorials/first_app/intro.html"><strong aria-hidden="true">4.</strong> Building Your First App</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../tutorials/first_app/setup.html"><strong aria-hidden="true">4.1.</strong> Installation and Setup</a></li><li class="chapter-item expanded "><a href="../tutorials/first_app/template.html"><strong aria-hidden="true">4.2.</strong> Writing Your First Template</a></li><li class="chapter-item expanded "><a href="../tutorials/first_app/app.html"><strong aria-hidden="true">4.3.</strong> Setting up the App Itself</a></li></ol></li><li class="chapter-item expanded "><a href="../cli.html"><strong aria-hidden="true">5.</strong> CLI</a></li><li class="chapter-item expanded "><a href="../templates.html"><strong aria-hidden="true">6.</strong> Templates</a></li><li class="chapter-item expanded "><a href="../routing.html"><strong aria-hidden="true">7.</strong> Routing</a></li><li class="chapter-item expanded "><a href="../error_pages.html"><strong aria-hidden="true">8.</strong> Error Pages</a></li><li class="chapter-item expanded "><a href="../strategies/intro.html"><strong aria-hidden="true">9.</strong> Rendering Strategies</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../strategies/build_paths.html"><strong aria-hidden="true">9.1.</strong> Build Paths</a></li><li class="chapter-item expanded "><a href="../strategies/build_state.html"><strong aria-hidden="true">9.2.</strong> Build State</a></li><li class="chapter-item expanded "><a href="../strategies/request_state.html" class="active"><strong aria-hidden="true">9.3.</strong> Request State</a></li><li class="chapter-item expanded "><a href="../strategies/revalidation.html"><strong aria-hidden="true">9.4.</strong> Revalidation</a></li><li class="chapter-item expanded "><a href="../strategies/incremental.html"><strong aria-hidden="true">9.5.</strong> Incremental generation</a></li></ol></li><li class="chapter-item expanded "><a href="../building.html"><strong aria-hidden="true">10.</strong> Building</a></li><li class="chapter-item expanded "><a href="../serving.html"><strong aria-hidden="true">11.</strong> Serving</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../integrations/actix-web.html"><strong aria-hidden="true">11.1.</strong> Actix Web Integration</a></li></ol></li><li class="chapter-item expanded "><a href="../config_managers.html"><strong aria-hidden="true">12.</strong> Config Managers</a></li></ol>        </div>
        <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
    </nav>

    <div id="page-wrapper" class="page-wrapper">

        <div class="page">
            <div id="menu-bar-hover-placeholder"></div>
            <style>
    header.warning {
        background-color: rgb(242, 222, 222);
        border-bottom-color: rgb(238, 211, 215);
        border-bottom-left-radius: 4px;
        border-bottom-right-radius: 4px;
        border-bottom-style: solid;
        border-bottom-width: 0.666667px;
        border-image-outset: 0 0 0 0;
        border-image-repeat: stretch stretch;
        border-image-slice: 100% 100% 100% 100%;
        border-image-source: none;
        border-image-width: 1 1 1 1;
        border-left-color: rgb(238, 211, 215);
        border-left-style: solid;
        border-left-width: 0.666667px;
        border-right-color: rgb(238, 211, 215);
        border-right-style: solid;
        border-right-width: 0.666667px;
        border-top-color: rgb(238, 211, 215);
        border-top-left-radius: 4px;
        border-top-right-radius: 4px;
        border-top-style: solid;
        border-top-width: 0.666667px;
        color: rgb(185, 74, 72);
        padding-bottom: 8px;
        padding-left: 14px;
        padding-right: 35px;
        padding-top: 8px;
        text-align: center;
        margin-bottom: 0px;
        margin-left: 0px;
        margin-right: 0px;
        margin-top: 30px;
    }
</style>
<header class="warning">
    This documentation is for the <strong>unpublished</strong> next version of Perseus,
    and features documented here may not yet be available in the existing releases.
    <br>
    You can find documentation for the most recently released version of Perseus
    <a href="https://arctic-hen7.github.io/perseus/stable.html">here</a>.
</header>

            <div id="menu-bar" class="menu-bar sticky bordered">
                <div class="left-buttons">
                    <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents"
                        aria-label="Toggle Table of Contents" aria-controls="sidebar">
                        <i class="fa fa-bars"></i>
                    </button>
                    <button id="theme-toggle" class="icon-button" type="button" title="Change theme"
                        aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                        <i class="fa fa-paint-brush"></i>
                    </button>
                    <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                        <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                        <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                        <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                        <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                        <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button>
                        </li>
                    </ul>
                                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)"
                        aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S"
                        aria-controls="searchbar">
                        <i class="fa fa-search"></i>
                    </button>
                                    </div>

                <h1 class="menu-title">Perseus Book</h1>

                <div class="right-buttons">
                                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                        <i id="print-button" class="fa fa-print"></i>
                    </a>
                                                            
                </div>
            </div>

                        <div id="search-wrapper" class="hidden">
                <form id="searchbar-outer" class="searchbar-outer">
                    <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..."
                        aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                </form>
                <div id="searchresults-outer" class="searchresults-outer hidden">
                    <div id="searchresults-header" class="searchresults-header"></div>
                    <ul id="searchresults">
                    </ul>
                </div>
            </div>
            
            <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
            <script type="text/javascript">
                document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                Array.from(document.querySelectorAll('#sidebar a')).forEach(function (link) {
                    link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                });
            </script>

            <div id="content" class="content">
                <main>
                    <h1 id="request-state"><a class="header" href="#request-state">Request State</a></h1>
<p>This strategy allows you to define the state for a page at request-time, which gives you access to information like the headers of the user's HTTP request (including any authorization tokens) and real-time factors. This can be useful if you want to render something like a user dashboard on the server, which you wouldn't be able to do with the <em>build state</em> strategy, as it only has access to information at build-time.</p>
<p>It should be noted that this strategy is much slower than build-time strategies, as it requires extra computations on the server every time a user requests a page. However, this strategy is superior to client-side rendering (rendering a page at build time with fillers for unique content that you then fill in in the browser) in some ways. This strategy is essentially server-side rendering, and you can read more about its performance <a href="https://medium.com/walmartglobaltech/the-benefits-of-server-side-rendering-over-client-side-rendering-5d07ff2cefe8">here</a>.</p>
<h2 id="using-with-build-state"><a class="header" href="#using-with-build-state">Using with Build State</a></h2>
<p>Perseus supports using both build and request state simultaneously, though it's not advised unless absolutely necessary. This will result in the generation of two competing states, one from build and one from request, which you can then amalgamate by using the <code>amalgamate_states</code> strategy. Due to the phenomenally niche nature of this approach, it's not covered in depth in the documentation, but you can check out the <code>showcase</code> example if you want to see it in action (specifically the <code>amalgamate</code> page).</p>
<h2 id="usage"><a class="header" href="#usage">Usage</a></h2>
<p>You can define a function for this strategy like so (this will tell the user their own IP address):</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use serde::{Deserialize, Serialize};
use perseus::ErrorCause;

#[derive(Serialize, Deserialize)]
pub struct IpPageProps {
    ip: String,
}
pub async fn get_request_state(_path: String, req: Request) -&gt; Result&lt;String, (String, ErrorCause)&gt; {
    Ok(serde_json::to_string(&amp;IpPageProps {
        // Gets the client's IP address
        ip: format!(
            &quot;{:?}&quot;,
            req
                .headers()
                .get(&quot;X-Forwarded-For&quot;)
                .unwrap_or(&amp;perseus::http::HeaderValue::from_str(&quot;hidden from view!&quot;).unwrap())
        ),
    })
    .unwrap())
}
<span class="boring">}
</span></code></pre></pre>
<p>This function can produce two kinds of errors, broadly: those caused by the server, and those caused by the client. For that reason, you need to return a <code>(String, ErrorCause)</code> tuple, the second part of which specifies who's responsible for the error. This allows Perseus to figure out whether it should send a 400 (client error) or 500 (server error) HTTP status code in the event of an error. This function must also be asynchronous.</p>
<p>As with the <em>build state</em> strategy, you must return state from this function as a string, and the path provided to this function is the same as the final path at which the page will be rendered.</p>
<p>You can add this strategy to a template like so:</p>
<pre><pre class="playground"><code class="language-rust no_run no_playground edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>template
	// ...
    .request_state_fn(Box::new(get_request_state))
<span class="boring">}
</span></code></pre></pre>

                </main>

                <nav class="nav-wrapper" aria-label="Page navigation">
                    <!-- Mobile navigation buttons -->
                                        <a rel="prev" href="../strategies/build_state.html" class="mobile-nav-chapters previous"
                        title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    
                                        <a rel="next" href="../strategies/revalidation.html" class="mobile-nav-chapters next"
                        title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                    
                    <div style="clear: both"></div>
                </nav>
            </div>
        </div>

        <nav class="nav-wide-wrapper" aria-label="Page navigation">
                        <a rel="prev" href="../strategies/build_state.html" class="nav-chapters previous" title="Previous chapter"
                aria-label="Previous chapter" aria-keyshortcuts="Left">
                <i class="fa fa-angle-left"></i>
            </a>
            
                        <a rel="next" href="../strategies/revalidation.html" class="nav-chapters next" title="Next chapter"
                aria-label="Next chapter" aria-keyshortcuts="Right">
                <i class="fa fa-angle-right"></i>
            </a>
                    </nav>

    </div>

    
    
    
        <script type="text/javascript">
        window.playground_copyable = true;
    </script>
    
    
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
    
    <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
    <script src="../book.js" type="text/javascript" charset="utf-8"></script>

    <!-- Custom JS scripts -->
    
    
</body>

</html>
