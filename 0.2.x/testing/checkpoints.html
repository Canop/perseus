<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Checkpoints - Perseus Book</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="../favicon.svg">
                        <link rel="shortcut icon" href="../favicon.png">
                <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
                <link rel="stylesheet" href="../css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="../fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../intro.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../what-is-perseus.html"><strong aria-hidden="true">1.1.</strong> What is Perseus?</a></li><li class="chapter-item expanded "><a href="../hello-world.html"><strong aria-hidden="true">1.2.</strong> Hello World!</a></li></ol></li><li class="chapter-item expanded "><a href="../second-app.html"><strong aria-hidden="true">2.</strong> Your Second App</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">Reference</li><li class="chapter-item expanded "><a href="../define-app.html"><strong aria-hidden="true">3.</strong> define_app!</a></li><li class="chapter-item expanded "><a href="../views.html"><strong aria-hidden="true">4.</strong> Writing Views</a></li><li class="chapter-item expanded "><a href="../debugging.html"><strong aria-hidden="true">5.</strong> Debugging</a></li><li class="chapter-item expanded "><a href="../templates/intro.html"><strong aria-hidden="true">6.</strong> Templates and Routing</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../templates/metadata-modification.html"><strong aria-hidden="true">6.1.</strong> Modifying the &lt;head&gt;</a></li><li class="chapter-item expanded "><a href="../templates/setting-headers.html"><strong aria-hidden="true">6.2.</strong> Modifying HTTP Headers</a></li></ol></li><li class="chapter-item expanded "><a href="../error-pages.html"><strong aria-hidden="true">7.</strong> Error Pages</a></li><li class="chapter-item expanded "><a href="../static-content.html"><strong aria-hidden="true">8.</strong> Static Content</a></li><li class="chapter-item expanded "><a href="../i18n/intro.html"><strong aria-hidden="true">9.</strong> Internationalization</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../i18n/defining.html"><strong aria-hidden="true">9.1.</strong> Defining Translations</a></li><li class="chapter-item expanded "><a href="../i18n/using.html"><strong aria-hidden="true">9.2.</strong> Using Translations</a></li><li class="chapter-item expanded "><a href="../i18n/translations-managers.html"><strong aria-hidden="true">9.3.</strong> Translations Managers</a></li><li class="chapter-item expanded "><a href="../i18n/other-engines.html"><strong aria-hidden="true">9.4.</strong> Other Translation Engines</a></li></ol></li><li class="chapter-item expanded "><a href="../strategies/intro.html"><strong aria-hidden="true">10.</strong> Rendering Strategies</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../strategies/build-state.html"><strong aria-hidden="true">10.1.</strong> Build State</a></li><li class="chapter-item expanded "><a href="../strategies/build-paths.html"><strong aria-hidden="true">10.2.</strong> Build Paths</a></li><li class="chapter-item expanded "><a href="../strategies/request-state.html"><strong aria-hidden="true">10.3.</strong> Request State</a></li><li class="chapter-item expanded "><a href="../strategies/revalidation.html"><strong aria-hidden="true">10.4.</strong> Revalidation</a></li><li class="chapter-item expanded "><a href="../strategies/incremental.html"><strong aria-hidden="true">10.5.</strong> Incremental Generation</a></li><li class="chapter-item expanded "><a href="../strategies/amlagamation.html"><strong aria-hidden="true">10.6.</strong> State Amalgamation</a></li></ol></li><li class="chapter-item expanded "><a href="../cli.html"><strong aria-hidden="true">11.</strong> CLI</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../ejecting.html"><strong aria-hidden="true">11.1.</strong> Ejecting</a></li></ol></li><li class="chapter-item expanded "><a href="../config-managers.html"><strong aria-hidden="true">12.</strong> Config Managers</a></li><li class="chapter-item expanded "><a href="../testing/intro.html"><strong aria-hidden="true">13.</strong> Testing</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../testing/checkpoints.html" class="active"><strong aria-hidden="true">13.1.</strong> Checkpoints</a></li><li class="chapter-item expanded "><a href="../testing/fantoccini-basics.html"><strong aria-hidden="true">13.2.</strong> Fantoccini Basics</a></li><li class="chapter-item expanded "><a href="../testing/manual.html"><strong aria-hidden="true">13.3.</strong> Manual Testing</a></li></ol></li><li class="chapter-item expanded "><a href="../styling.html"><strong aria-hidden="true">14.</strong> Styling</a></li><li class="chapter-item expanded "><a href="../deploying/intro.html"><strong aria-hidden="true">15.</strong> Deploying</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../deploying/exporting.html"><strong aria-hidden="true">15.1.</strong> Static Exporting</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">15.2.</strong> Server Deployment</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">15.3.</strong> Serverless Deployment</div></li></ol></li><li class="chapter-item expanded "><a href="../updating.html"><strong aria-hidden="true">16.</strong> Migrating from v0.1.x</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">Advanced</li><li class="chapter-item expanded "><a href="../advanced/intro.html"><strong aria-hidden="true">17.</strong> Under the Hood</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../advanced/arch.html"><strong aria-hidden="true">17.1.</strong> Architecture</a></li><li class="chapter-item expanded "><a href="../advanced/initial-loads.html"><strong aria-hidden="true">17.2.</strong> Initial Loads</a></li><li class="chapter-item expanded "><a href="../advanced/subsequent-loads.html"><strong aria-hidden="true">17.3.</strong> Subsequent Loads</a></li><li class="chapter-item expanded "><a href="../advanced/routing.html"><strong aria-hidden="true">17.4.</strong> Routing</a></li></ol></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">Perseus Book</h1>

                    <div class="right-buttons">
                                                <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="checkpoints"><a class="header" href="#checkpoints">Checkpoints</a></h1>
<p>If you start using Perseus' testing system now, you'll likely hit a snag very quickly, involving errors to do with <em>stale DOM elements</em>. This is an unfortunate side-effect of the way Perseus currently handles initial loads (we move a number of DOM elements around after they've been sent down from the server), which results in the WebDriver thinking half the page has just disappeared out from under it!</p>
<p>This, and many similar problems, are easily solvable using one of Perseus' most powerful testing tools: <em>checkpoints</em>. When you run your app with <code>perseus test</code>, a system is enabled in the background that writes a new DOM element to a hidden list of them when any app code calls <code>checkpoint()</code>. This can then be detected with Fantoccini! Admittedly, a far nicer solution would be DOM events, but the WebDriver protocol doesn't yet support listening for them (understandable since it's mimicking a user's interaction with the browser).</p>
<p>Note that checkpoints will never be reached if your app is not run with <code>perseus test</code>. If you use <code>--no-run</code> and then execute the server binary manually, be sure to provide the <code>PERSEUS_TESTING=true</code> environment variable.</p>
<p>You can wait for a Perseus checkpoint to be reached like so (taken from <a href="https://github.com/arctic-hen7/perseus/blob/main/examples/basic/tests/main.rs">here</a>):</p>
<pre><pre class="playground"><code class="language-rust no_run no_playground edition2018">use fantoccini::{Client, Locator};
use perseus::wait_for_checkpoint;

#[perseus::test]
async fn main(c: &amp;mut Client) -&gt; Result&lt;(), fantoccini::error::CmdError&gt; {
    c.goto(&quot;http://localhost:8080&quot;).await?;
    wait_for_checkpoint!(&quot;begin&quot;, 0, c);
    let url = c.current_url().await?;
    assert!(url.as_ref().starts_with(&quot;http://localhost:8080&quot;));

    // The greeting was passed through using build state
    wait_for_checkpoint!(&quot;initial_state_present&quot;, 0, c);
    wait_for_checkpoint!(&quot;page_visible&quot;, 0, c);
    let greeting = c.find(Locator::Css(&quot;p&quot;)).await?.text().await?;
    assert_eq!(greeting, &quot;Hello World!&quot;);
    // For some reason, retrieving the inner HTML or text of a `&lt;title&gt;` doens't work
    let title = c.find(Locator::Css(&quot;title&quot;)).await?.html(false).await?;
    assert_eq!(title, &quot;&lt;title&gt;Index Page | Perseus Example – Basic&lt;/title&gt;&quot;);

    // Go to `/about`
    c.find(Locator::Id(&quot;about-link&quot;)).await?.click().await?;
    let url = c.current_url().await?;
    assert!(url.as_ref().starts_with(&quot;http://localhost:8080/about&quot;));
    wait_for_checkpoint!(&quot;initial_state_not_present&quot;, 0, c);
    wait_for_checkpoint!(&quot;page_visible&quot;, 1, c);
    // Make sure the hardcoded text there exists
    let text = c.find(Locator::Css(&quot;p&quot;)).await?.text().await?;
    assert_eq!(text, &quot;About.&quot;);
    let title = c.find(Locator::Css(&quot;title&quot;)).await?.html(false).await?;
    assert_eq!(title, &quot;&lt;title&gt;About Page | Perseus Example – Basic&lt;/title&gt;&quot;);
    // Make sure we get initial state if we refresh
    c.refresh().await?;
    wait_for_checkpoint!(&quot;initial_state_present&quot;, 0, c);

    Ok(())
}
</code></pre></pre>
<p>Note in particular the use of the <code>wait_for_checkpoint!</code> macro, which accepts three arguments:</p>
<ul>
<li>Name of the checkpoint</li>
<li>Version of the checkpoint</li>
<li>Fantoccini client</li>
</ul>
<p>For want of a better term, that second argument refers to how Perseus manages checkpoints. Because a single checkpoint might be emitted multiple times, Perseus attaches a number to the end of each. The final element <code>id</code> looks like this: <code>__perseus_checkpoint-&lt;checkpoint_name&gt;-&lt;number&gt;</code>, where <code>&lt;number&gt;</code> starts from 0 and increments.</p>
<p><em>Note: checkpoints are not cleared until the page is fully reloaded, so clicking a link to another page will not clear them!</em></p>
<h2 id="custom-checkpoints"><a class="header" href="#custom-checkpoints">Custom Checkpoints</a></h2>
<p>In addition to Perseus' internal checkpoints (listed below), you can also use your own checkpoints, though they must follow the following criteria:</p>
<ul>
<li>Must not include hyphens (used as a delimiter character), use underscores instead</li>
<li>Must not conflict with an internal Perseus checkpoint name</li>
</ul>
<p>The best way to uphold the latter of those criteria is to prefix your own checkpoints with something like the name of your app, or even just <code>custom_</code>. Of course, if your app has a name like <code>router</code>, then that will be a problem (many Perseus checkpoints begin with <code>router_</code>), but Perseus will never generate checkpoints internally that begin with <code>custom_</code>.</p>
<p>Note that it's not enough to make sure that your checkpoints don't clash with any existing checkpoints, as new checkpoints may be added in any new release of Perseus, so conflicts may arise with the tiniest of updates!</p>
<h2 id="internal-checkpoints"><a class="header" href="#internal-checkpoints">Internal Checkpoints</a></h2>
<p>Perseus has a number of internal checkpoints that are listed below. Note that this list will increase over time, and potentially in patch releases.</p>
<ul>
<li><code>begin</code> -- when the Perseus system has been initialized</li>
<li><code>router_entry</code> -- when the Perseus router has reached a verdict and is about to either render a new page, detect the user's locale and redirect, or show an error page</li>
<li><code>not_found</code> -- when the page wasn't found</li>
<li><code>app_shell_entry</code> -- when the page was found and it's being rendered</li>
<li><code>initial_state_present</code> -- when the page has been rendered for the first time, and the server has preloaded everything (see <a href="../advanced/initial-loads.html">here</a> for details)</li>
<li><code>page_visible</code> -- when the user is able to see page content (but the page isn't interactive yet)</li>
<li><code>page_interactive</code> -- when the page has been hydrated, and is now interactive</li>
<li><code>initial_state_not_present</code> -- when the initial state is not present, and the app shell will need to fetch page data from the server</li>
<li><code>initial_state_error</code> -- when initial state showed an error</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="../testing/intro.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="../testing/fantoccini-basics.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="../testing/intro.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="../testing/fantoccini-basics.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        
    </body>
</html>
